<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/atom.xml" title="Charles' Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.2" />



<link rel="canonical" href="https://w2x.me/page/6/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.2" />



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-77440077-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-77440077-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> Charles' Blog </title>
  <meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Charles' Blog" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Charles' Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags/">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories/">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Charles' Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            
            
              Categories
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              About
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <section id="posts" class="posts">
    
      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/12/21/Grails-JSON-Views-%E6%95%99%E7%A8%8B/">Grails JSON Views 教程</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-12-21
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>Grails 3.2版本中的rest-api profile加入了JSON View插件，JSON View插件主要用于渲染JSON返回内容，类似于GSP，其好处就是将JSON渲染从控制器层移到了视图层，同时JSON View还能定义模板，继承等。</p>
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>JSON View视图文件以<code>.gson</code>为扩展名，且文件要放在<code>grails-app/views</code>目录下。<br>例：person.gson</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">json.person &#123;</span><br><span class="line">    name &quot;bob&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的JSON值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;person&quot;:&#123;&quot;name&quot;:&quot;bob&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建模版"><a href="#创建模版" class="headerlink" title="创建模版"></a>创建模版</h3><p>模版文件需要以<code>_</code>开头，比如你有一个类名叫QueryResult,则其模版文件完整路径为<code>grails-app/views/queryResult/_queryResult.gson</code><br>例：<code>Author.groovy</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Author &#123;</span><br><span class="line">    String name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模版：<code>grails-app/views/author/_author.gson</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">model &#123;</span><br><span class="line">    Author author</span><br><span class="line">&#125;</span><br><span class="line">json &#123;</span><br><span class="line">    name author.name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以简写为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Field Author author</span><br><span class="line">json &#123;</span><br><span class="line">    name author.name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果Author类是Domain Object的话，则模版文件可以写成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Field Author author</span><br><span class="line">json g.render(author)</span><br></pre></td></tr></table></figure>

<h3 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h3><h4 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">model &#123;</span><br><span class="line">    Book book</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">json g.render(book, [deep: false, renderNulls: true]) &#123;</span><br><span class="line">    authorName book.author?.name</span><br><span class="line">    publishDate new Date().time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="集合渲染"><a href="#集合渲染" class="headerlink" title="集合渲染"></a>集合渲染</h4><p>例1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">model &#123;</span><br><span class="line">    Author author</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">json &#123;</span><br><span class="line">    name author.name</span><br><span class="line">    books g.render(template: &#39;&#x2F;book&#x2F;book&#39;, collection: author.books, var: &#39;book&#39;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/book/book</code>引用的是<code>grails-app/views/book</code>目录下名为<code>_book.gson</code>的模版文件</p>
<p>例2：<br>如果返回结果是个集合，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class AuthorController &#123;</span><br><span class="line">    static responseFormats &#x3D; [&#39;json&#39;, &#39;xml&#39;]</span><br><span class="line"></span><br><span class="line">    def index() &#123;</span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 这里需要注意res的类型，</span><br><span class="line">         * 如果是List类型，则json view中的model名称则为authorList</span><br><span class="line">         * 如果是Set类型，则json view中的model名称则为authorSet</span><br><span class="line">         *&#x2F;</span><br><span class="line">        def res &#x3D; Author.list()</span><br><span class="line">        respond(res, [view: &#39;authorList&#39;])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>这里要注意下<code>res</code>的类型</strong></p>
<ul>
<li>如果是List类型，则json view中的model名称则为authorList</li>
<li>如果是Set类型，则json view中的model名称则为authorSet</li>
</ul>
</li>
<li><p>Grails默认会在<code>grails-app/views/author/</code>路径下查找<code>authorList.gson</code>视图文件</p>
</li>
<li><p>如果需要在其他Controller下引用该视图的话，需要写绝对路径<code>/author/authorList</code></p>
</li>
</ul>
<p><code>_author.gson</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">model &#123;</span><br><span class="line">    Author author</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">json &#123;</span><br><span class="line">    name author.name</span><br><span class="line">    books g.render(template: &#39;&#x2F;book&#x2F;book&#39;, collection: author.books, var: &#39;book&#39;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>authorList.gson</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">model &#123;</span><br><span class="line">    Collection&lt;Author&gt; authorList &#x3D; []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">json tmpl.author(authorList)</span><br></pre></td></tr></table></figure>
<p><strong>authorList要指定下默认值<code>[]</code>，如果不指定的话会返回<code>[null]</code>这种JSON</strong></p>
<h4 id="渲染参数"><a href="#渲染参数" class="headerlink" title="渲染参数"></a>渲染参数</h4><p>你可以通过<code>includes</code>和<code>excludes</code>参数，来包含或排除一些字段，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Field Author author</span><br><span class="line">json g.render(author，[includes:[&#39;title&#39;])</span><br></pre></td></tr></table></figure>
<p>你也可以自定义额外输出的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">json g.render(author) &#123;</span><br><span class="line">    age 30</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在默认情况下，JSON View不会返回值为<code>null</code>的字段，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class Author &#123;</span><br><span class="line">    String name</span><br><span class="line">    Integer age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Field Author author</span><br><span class="line">json g.render(author)</span><br><span class="line"></span><br><span class="line">def a &#x3D; new Author(name: &#39;charles&#39;,age: 12) &#x3D;&gt; &#123;name:&#39;chalres&#39;,age: 12&#125;</span><br><span class="line">def b &#x3D; new Author(name: null,age: 29)&#x3D;&gt; &#123;age: 29&#125;</span><br></pre></td></tr></table></figure>
<p>这时候你可以设直<code>renderNulls</code>来返回空值字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Field Author author</span><br><span class="line">json g.render(author,[renderNulls: true])</span><br></pre></td></tr></table></figure>
<p>则b的返回中就变成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def b &#x3D; new Author(name: null,age: 29)&#x3D;&gt; &#123;name: null,age: 29&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完整的例子"><a href="#完整的例子" class="headerlink" title="完整的例子"></a>完整的例子</h3><p><a href="https://github.com/wancaibida/grails-json-views-example" target="_blank" rel="noopener">https://github.com/wancaibida/grails-json-views-example</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>JSON View用下来还是遇到了不少的问题，主要原因是其约定太多且官方的文档也说的不是很清楚，有 些地方还是要一步步调试来研究源代码，但总的来说比传统的在代码中指定JSON格式方便了不少，用好了能节约不少时间与工作量。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://github.com/skyboy101/widget-store-rest-api" target="_blank" rel="noopener">https://github.com/skyboy101/widget-store-rest-api</a><br><a href="http://views.grails.org/1.1.x/" target="_blank" rel="noopener">http://views.grails.org/1.1.x/</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/12/03/%E8%AE%B0%E4%B8%80%E4%B8%AAGrails-JSON-Views%E7%9A%84Bug/">记一个Grails JSON Views的Bug</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-12-03
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>最近项目用到了3.2版本的Grails，这个版本中引入了一个新特性JSON views，主要作用是将JSON返回内容视为一种视图,类似于GSP。其好处就是可以在视图层定义返回json的格式，而且可以定义bean的JSON模版，比较灵活。</p>
<p>项目中有一个名为<code>QueryResult</code>的类，并设置了<code>QueryResult</code>类的模版，名为<code>_queryresult.gson</code>。</p>
<p>文件目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bean</span><br><span class="line">    package...</span><br><span class="line">        QueryResult.groovy</span><br><span class="line">views</span><br><span class="line">    queryResult</span><br><span class="line">        _queryresult.gson</span><br></pre></td></tr></table></figure>
<p>Controller代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def list(xxx)&#123;</span><br><span class="line">    new QueryResult(xxx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目在本地开发时没有什么问题，但部署到生产环境时，这个方法返回内空始终为空。</p>
<p>项目在本地开发时是在内置的tomcat运行的，而在生产环境中项目是打包成war文件部署在Linux下的Tomcat。猜测问题可能是项目运行方式不同导致。</p>
<p>调试后发现了如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">WritableScriptTemplate template</span><br><span class="line">if (Environment.isDevelopmentEnvironmentAvailable()) &#123;</span><br><span class="line">    template &#x3D; attemptResolvePath(path)</span><br><span class="line">    if (template &#x3D;&#x3D; null) &#123;</span><br><span class="line">        template &#x3D; attemptResolveClass(path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    template &#x3D; attemptResolveClass(path)</span><br><span class="line">    if (template &#x3D;&#x3D; null) &#123;</span><br><span class="line">        template &#x3D; attemptResolvePath(path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (template &#x3D;&#x3D; null) &#123;</span><br><span class="line">    template &#x3D; NULL_ENTRY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码的基本意思是，如果是在开发环境下，模版内容优先通过文件路径来查找，如果没有找到则通过类名来查找，而在生产环境正好反过来。</p>
<p>模版文件<code>_queryresult.gson</code>编译后会生成名为<code>xxx_queryResult__queryresult_gson.class</code>的java类。</p>
<p>JSON Views插件会通过一系列约定的命名方式来找所需要的视图，最终会查找名为<code>xxx_queryResult__queryResult_gson.class</code>的java类（注意：第二个queryResult中的R是大写的），前面说到开发环境下会先通过文件名称来查找，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;实际文件名为：xxx_queryResult__queryresult_gson.class</span><br><span class="line">def templateFile &#x3D; new File(&#39;xxx_queryResult__queryResult_gson.class&#39;)</span><br><span class="line">if(templateFile.exist())&#123;</span><br><span class="line">    return templateFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>，如果文件存在，则返回。可实际的class文件名为<code>xxx_queryResult__queryresult_gson.class</code>，但我开发环境的文件系统是<strong>大小写不敏感</strong>的！！，所以对于系统来说<code>xxx_queryResult__queryresult_gson.class</code>和<code>xxx_queryResult__queryResult_gson.class</code>是同样的文件名，<code>exist</code>方法最终是通过系统的API来寻找文件的，所以<code>templateFile.exist()</code>这句返回结果为真。</p>
<p>在生产环境是下是优先通过类名来查找的，要查找的类名为<code>xxx_queryResult__queryResult_gson.class</code>，而实际的类名为<code>xxx_queryResult__queryresult_gson.class</code>，而java类名是区分大小写的，所以会导致类找不到。</p>
<p>一旦通过类名查找不成功，则会通过文件路径来查，而Linux的文件系统是<strong>大小写敏感</strong>的，所以会无法找到名为<code>xxx_queryResult__queryResult_gson.class</code>的文件。</p>
<p>最终把模版文件名重命名为<code>_queryResult.gson</code>，接口就运行正常了。</p>
<p>总结：<br>严格来说这个BUG是文件系统对大小写处理的差异导制的，所以在开发时要考虑到文件系统对大小写处理不一致的问题。</p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/12/02/Intellij%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95Tomcat/">Intellij远程调试Tomcat</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-12-02
        </span>
        
          <span class="post-category">
            
              <a href="/categories/ide/">ide</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <ol>
<li><p>在Tomcat下新建<code>setenv.sh</code>文件</p>
</li>
<li><p>运行<code>chmod 755 setenv.sh</code></p>
</li>
<li><p>将下面的代码添加到<code>setenv.sh</code>文件中</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CATALINA_OPTS&#x3D;&quot;-agentlib:jdwp&#x3D;transport&#x3D;dt_socket,address&#x3D;1043,server&#x3D;y,suspend&#x3D;n&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>Intellij Run/Debug Configurations下新建Tomcat Server Remote<br>![Screen Shot 2017-12-02 at 13.53.42](<a href="http://static.w2x.me/2017-12-02-Screen" target="_blank" rel="noopener">http://static.w2x.me/2017-12-02-Screen</a> Shot 2017-12-02 at 13.53.42.png)</p>
</li>
<li><p>在新建的页面先择<code>Starup/Connection</code>标签,然后选择Debug选项<br>![Screen Shot 2017-12-02 at 13.56.20](<a href="http://static.w2x.me/2017-12-02-Screen" target="_blank" rel="noopener">http://static.w2x.me/2017-12-02-Screen</a> Shot 2017-12-02 at 13.56.20.png)</p>
</li>
<li><p>将<code>Port</code>的值修改为<code>1043</code><br>![Screen Shot 2017-12-02 at 13.58.42](<a href="http://static.w2x.me/2017-12-02-Screen" target="_blank" rel="noopener">http://static.w2x.me/2017-12-02-Screen</a> Shot 2017-12-02 at 13.58.42.png)</p>
</li>
<li><p>Tomcat启动后,Intellij即可远程Debug</p>
</li>
</ol>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/11/20/Kubernetes%E5%85%A5%E9%97%A8/">Kubernetes入门</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-11-20
        </span>
        
          <span class="post-category">
            
              <a href="/categories/docker/">docker</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h1 id="Kubernetes入门"><a href="#Kubernetes入门" class="headerlink" title="Kubernetes入门"></a>Kubernetes入门</h1><h2 id="Kubernetes是什么"><a href="#Kubernetes是什么" class="headerlink" title="Kubernetes是什么"></a>Kubernetes是什么</h2><p>Kubernetes是用来自动化部署,扩展,管理容器应用的工具.</p>
<h2 id="Kubernetes架构"><a href="#Kubernetes架构" class="headerlink" title="Kubernetes架构"></a>Kubernetes架构</h2><p>Kubernetes主要由Master和Node两部分组成.<br><img src="http://static.w2x.me/0.png" alt="Architecture"></p>
<h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><p>Kubernetes集群包含至少一个Master节点和多个Node节点.Master节点主要用来暴露API,调度部署和管理整个集群.</p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Node是工作节点,Node可能是物理机器也可能是虚拟机,每个节点上都提供了容器的运行环境,比如说Docker,rkt.</p>
<h2 id="Kubernetes对象"><a href="#Kubernetes对象" class="headerlink" title="Kubernetes对象"></a>Kubernetes对象</h2><p>Kubernetes对象持久化在kubernetes系统中,Kubernetes用这些对象来描述集群的状态,比如:</p>
<ul>
<li>部署的应用</li>
<li>应用的行为,比如重启,升级策略</li>
<li>应用程序可用的资源</li>
</ul>
<h3 id="描述Kubernetes对象"><a href="#描述Kubernetes对象" class="headerlink" title="描述Kubernetes对象"></a>描述Kubernetes对象</h3><p>我们通常会通过.yaml来描述Kuberntes对象,Kubernetes客户端会将yaml文件转成JSON来调用API.<br>例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>
<p>我们可以通过下面的命令来创建Kubernetes对象:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f docs&#x2F;user-guide&#x2F;nginx-deployment.yaml --record</span><br></pre></td></tr></table></figure>

<h4 id="字段说明"><a href="#字段说明" class="headerlink" title="字段说明"></a>字段说明</h4><p>在yaml文件中,你需要声明以下字段:</p>
<ul>
<li>apiVersion - 调用的API版本</li>
<li>kind - 对象类型</li>
<li>metadata - 用于查找对象的字段,比如名称,UID,命名空间</li>
</ul>
<p>一些常见的kubernetes对象有:</p>
<ul>
<li>Pod</li>
<li>Deployments</li>
<li>Service</li>
<li>Ingress</li>
</ul>
<h3 id="Pod对象"><a href="#Pod对象" class="headerlink" title="Pod对象"></a>Pod对象</h3><p>Pod对象是最小的布署单元,包含了一个或多个容器.通常我们不会单独使用Pod.<br>Controller对象可创建多个Pod,常风的Controller对象有:</p>
<ul>
<li>Deployment</li>
<li>StatefulSet</li>
<li>DaemonSet</li>
</ul>
<h3 id="Deployments对象"><a href="#Deployments对象" class="headerlink" title="Deployments对象"></a>Deployments对象</h3><p>Deployments对象可以创建Pod,在Deployments对象中你只需要描述你需要的状态,Deployments对象会将当前状态改变成你所需要的状态.</p>
<p> 例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>
<p>上面的描述文件创建了3个运行Nginx的Pod对象.</p>
<p>通过下面命令来部署和查看Deployments对象:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f docs&#x2F;user-guide&#x2F;nginx-deployment.yaml --record</span><br><span class="line">kubectl get deployment</span><br></pre></td></tr></table></figure>

<h3 id="Service对象"><a href="#Service对象" class="headerlink" title="Service对象"></a>Service对象</h3><p>Service对象将Pod对象抽像成一种服务,并定义了访问这些Pod对象的策略,类似于负载均衡(Loadbalancer).Service对象会通过选择器来选择Pod对象.</p>
<p>例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 9376</span><br></pre></td></tr></table></figure>
<h3 id="Ingress对象"><a href="#Ingress对象" class="headerlink" title="Ingress对象"></a>Ingress对象</h3><p>Ingress对象定义了外部请求如何转发到Service,类似于反向代理.<br>例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">  annotations:</span><br><span class="line">    ingress.kubernetes.io&#x2F;rewrite-target: &#x2F;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: foo.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;foo</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: s1</span><br><span class="line">          servicePort: 80</span><br><span class="line">      - path: &#x2F;bar</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: s2</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>
<p>上面的描述文件定义了Service的访问规则,foo上下文路径会被转发到名为s1的Service,bar上下文路径转发到名为s2的Service.</p>
<p>简而言之:</p>
<ul>
<li>Deployments定义了怎样部署应用(应用image,部署多少实例,启动策略等);</li>
<li>Service定义了如何抽像Deployments为服务,类似于负载均衡;</li>
<li>Ingress定义了请求如何转发到Service,类似反向代理,如nginx.</li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/10/30/Spring-Boot-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%80%BC/">Spring Boot YAML配置文件设置字段默认值</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-10-30
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>SpringBoot中application.yaml如何设置配置项默认值一直困扰了我很久,官方文档也没有写如何设置默认值,今天有时间研究了下,发现只要加个冒号就可以了,如<code>${配置名:默认值}</code>.</p>
<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appconfig:</span><br><span class="line">  fileServerAccessKey: $&#123;FILE_SERVER_ACCESS_KEY:default_access_key&#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h2 id="配置文件类"><a href="#配置文件类" class="headerlink" title="配置文件类"></a>配置文件类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@ConfigurationProperties(prefix &#x3D; &quot;appconfig&quot;)</span><br><span class="line">class Config &#123;</span><br><span class="line">    String fileServerSecretKey</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果项目未设置<code>FILE_SERVER_ACCESS_KEY</code>环境变量,则fileServerSecretKey字段会以<code>default_access_key</code>为默认值.</p>
<p>研究了下源码发现 <a href="https://github.com/spring-projects/spring-framework/blob/49787493a6ca3726df62c4aff85023e8fa589ed3/spring-core/src/main/java/org/springframework/util/PropertyPlaceholderHelper.java#L147" target="_blank" rel="noopener">PropertyPlaceholderHelper.java#L147</a>这个类先会检查配置值中是否包含<code>valueSeparator</code>这个字符串,如果有,则会用<code>valueSeparator</code>来分割字符,从中取出默认值,而<code>valueSeparator</code>默认值就是<code>:</code>. </p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/06/Linux%E4%B8%8B%E5%90%AF%E5%8A%A8Java%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E6%96%B9%E6%B3%95/">Linux下启动Java守护进程方法</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-06
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">DESC=<span class="string">"Java Service"</span></span><br><span class="line">NAME=java-service</span><br><span class="line">PIDFILE=/tmp/<span class="variable">$NAME</span>.pid</span><br><span class="line">PATH_TO_JAR=~/java-service.jar</span><br><span class="line">PATH_TO_JAVA=/usr/<span class="built_in">local</span>/jdk1.8.0_131/bin/java</span><br><span class="line">SERVICE_CONFIG=<span class="string">'-Dserver.port=8080 -DLOG_PATH=/var/log'</span></span><br><span class="line">COMMAND=<span class="string">"<span class="variable">$PATH_TO_JAVA</span> -- <span class="variable">$SERVICE_CONFIG</span> -jar <span class="variable">$PATH_TO_JAR</span>"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">d_start</span></span>() &#123;</span><br><span class="line">    start-stop-daemon --start --quiet --background --make-pidfile --pidfile <span class="variable">$PIDFILE</span>  --<span class="built_in">exec</span> <span class="variable">$COMMAND</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">d_stop</span></span>() &#123;</span><br><span class="line">    start-stop-daemon --stop --quiet --pidfile <span class="variable">$PIDFILE</span></span><br><span class="line">    <span class="keyword">if</span> [ -e <span class="variable">$PIDFILE</span> ]</span><br><span class="line">        <span class="keyword">then</span> rm <span class="variable">$PIDFILE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"Starting <span class="variable">$DESC</span>: <span class="variable">$NAME</span>"</span></span><br><span class="line">    d_start</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"."</span></span><br><span class="line">    ;;</span><br><span class="line">    stop)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"Stopping <span class="variable">$DESC</span>: <span class="variable">$NAME</span>"</span></span><br><span class="line">    d_stop</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"."</span></span><br><span class="line">    ;;</span><br><span class="line">    restart)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"Restarting <span class="variable">$DESC</span>: <span class="variable">$NAME</span>"</span></span><br><span class="line">    d_stop</span><br><span class="line">    sleep 1</span><br><span class="line">    d_start</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"."</span></span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$NAME</span> &#123;start|stop|restart&#125;"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/03/HPKP-HTTP-Public-Key-Pinning-%E8%AF%A6%E8%A7%A3/">HPKP(HTTP Public Key Pinning)详解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-03
        </span>
        
          <span class="post-category">
            
              <a href="/categories/security/">security</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="HPKP是什么"><a href="#HPKP是什么" class="headerlink" title="HPKP是什么"></a>HPKP是什么</h3><p>HPKP(HTTP Public Key Pinning)又名公钥打孔,可以通过告知客户端将特定的加密公钥与特定服务器关联,以减少通过伪造证书进行中间人攻击(MITM)的风险.</p>
<h3 id="HPKP原理"><a href="#HPKP原理" class="headerlink" title="HPKP原理"></a>HPKP原理</h3><p>HPKP是一种首次信任技术,当客户端第一次访问服务器的时候,服务器通过特定的HTTP头来告知客户端哪些公钥是属于它的,客户端会将该信息存储一段时间,当客户端第二次访问服务端的时候,它会期望当前证书链中至少有一个证书的公钥指纹与通过HPKP已知的公钥指纹相匹配,如果没有找到匹配的公钥指纹,客户端应该警告用户.</p>
<h3 id="生成HPKP"><a href="#生成HPKP" class="headerlink" title="生成HPKP"></a>生成HPKP</h3><p>公钥指纹可以通过openssl命令来成成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"> </span><br><span class="line">openssl s_client -connect [YOUR_DOMAIN]:443 -showcerts | awk &#39;&#x2F;-----BEGIN&#x2F;&#123;f&#x3D;&quot;cert.&quot;(n++)&#125; f&#123;print&gt;f&#125; &#x2F;-----END&#x2F;&#123;f&#x3D;&quot;&quot;&#125;&#39;</span><br><span class="line"> </span><br><span class="line"> for c in cert.*; do</span><br><span class="line">   openssl x509 &lt;$c -noout -pubkey | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</span><br><span class="line"> done</span><br></pre></td></tr></table></figure>
<p>上面的命令会将当前证书链中的所有公钥指纹以base64格式打印出来.</p>
<p>公钥指纹也可以通过在线网站<a href="https://report-uri.io/home/pkp_hash" target="_blank" rel="noopener">REPORT URI</a>来生成 </p>
<h3 id="备份密钥-Backup-Key"><a href="#备份密钥-Backup-Key" class="headerlink" title="备份密钥(Backup Key)"></a>备份密钥(Backup Key)</h3><h4 id="什么是备份密钥"><a href="#什么是备份密钥" class="headerlink" title="什么是备份密钥"></a>什么是备份密钥</h4><p>备份密钥是不属于当前证书链的公钥指纹</p>
<h4 id="为什么要备份密钥"><a href="#为什么要备份密钥" class="headerlink" title="为什么要备份密钥"></a>为什么要备份密钥</h4><p>假设你只对你的子证书(leaf certificate)做了公钥指纹,你发现你的证书私钥被泄露了,这时你不得不更换当前的证书,这时唯一能恢复的办法就是将当前证书切换到备份密钥指向的备份证书.</p>
<h3 id="其他类似备份密钥的方法"><a href="#其他类似备份密钥的方法" class="headerlink" title="其他类似备份密钥的方法"></a>其他类似备份密钥的方法</h3><p>备份密钥的缺点也很明显,你需要同时支付至少两份证书的钱.</p>
<p>另一个办法就是你可以拿另一家证书颁发机构(CA)的公钥指纹做为备份密钥,当你要更换证书的时候,你只需要在这家CA申请一份新的证书.当然这么做也有缺点,当这家CA被黑,攻击者可以给自己颁发一份你网站的证书同时又通过你的HPKP验证,应为这份恶意证书也在CA的证书链上.</p>
<p>MDN上建议网站要有一个备份密钥</p>
<blockquote>
<p>HPKP has the potential to lock out users for a long time if used incorrectly! The use of backup certificates and/or pinning the CA certificate is recommended.</p>
</blockquote>
<p>但在Chrome(59.0.3071.115)下测试,如果HPKP头不包含备份密钥Chrome将忽略该头.</p>
<h3 id="添加HPKP头"><a href="#添加HPKP头" class="headerlink" title="添加HPKP头"></a>添加HPKP头</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.setHeader(&#39;Public-Key-Pins&#39;, &#39;pin-sha256&#x3D;&quot;base64+primary&#x3D;&#x3D;&quot;; pin-sha256&#x3D;&quot;base64+backup&#x3D;&#x3D;&quot;; max-age&#x3D;5184000; includeSubDomains&#39;)</span><br></pre></td></tr></table></figure>

<p><strong>sha256</strong><br>公钥的哈希值,base64编码</p>
<p><strong>max-age</strong><br>在浏览器的存储时间</p>
<p><strong>includeSubDomains</strong><br>对子域名是否有效</p>
<p><strong>report-uri</strong><br>验证失败后调用的URL(注:必须不同域名)</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>用HPKP的网站比较少,就发现github在用.</p>
<p>HPKP缺点也很明显:出错的成本太高,当你不得不切换到备份密钥指向的证书时,如果备份密钥配错了而且你只有一个备份密钥,你的网站将会无法被访问,无法访问的时间取决于max-age的值,比如上面的例子max-age配了两个月,那你的用户将在两个月内无法访问你的网站,这后果是灾难性的.</p>
<p>个人认为HPKP带来的风险大于收益,不建议使用.</p>
<h3 id="外部链接"><a href="#外部链接" class="headerlink" title="外部链接"></a>外部链接</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning" target="_blank" rel="noopener">HTTP Public Key Pinning (HPKP)</a></p>
<p><a href="https://timtaubert.de/blog/2014/10/http-public-key-pinning-explained/" target="_blank" rel="noopener">HTTP PUBLIC-KEY-PINNING EXPLAINED
</a></p>
<p><a href="https://scotthelme.co.uk/guidance-on-setting-up-hpkp/" target="_blank" rel="noopener">Guidance on setting up HPKP
</a></p>
<p><a href="https://blog.qualys.com/ssllabs/2016/09/06/is-http-public-key-pinning-dead" target="_blank" rel="noopener">Is HTTP Public Key Pinning Dead?</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/14/PostgreSQL-JDBC-time%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%BB%86%E8%8A%82/">PostgreSQL JDBC 时间类型存取细节</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-14
        </span>
        
          <span class="post-category">
            
              <a href="/categories/database/">database</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <ul>
<li>PostgreSQL中默认时区为UTC</li>
<li>record表中有一类型为Time without timezone的字段event_time</li>
<li>本机的时区为UTC+8</li>
</ul>
<p>现象:</p>
<ul>
<li>在页面提交的时间为 15:00:00+0</li>
<li>到了数据库时间却显示为 23:00:00+0</li>
<li>查询出来后页面显示的时间是 15:00:00+0</li>
<li>控制台打印出来的SQL如下:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into record (id, event_time) values (nextval (&#39;hibernate_sequence&#39;), &#39;23:00:00.000000 +08:00:00&#39;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>原因:<br>查看源代码,发现在生成insert语句时,JDBC会通过toString方法将Time类型转成String,而问题就出现在Time转String这里,cal对象是取的JVM的默认时区,而JVM默认时区取的应是本机的时区UTC+8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public synchronized String toString(Calendar cal, Time x) &#123;</span><br><span class="line">        if(cal &#x3D;&#x3D; null) &#123;</span><br><span class="line">            cal &#x3D; this.defaultCal;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cal.setTime(x);</span><br><span class="line">        this.sbuf.setLength(0);</span><br><span class="line">        appendTime(this.sbuf, cal, cal.get(14) * 1000000);</span><br><span class="line">        if(this.min74) &#123;</span><br><span class="line">            this.appendTimeZone(this.sbuf, cal);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        showString(&quot;time&quot;, cal, x, this.sbuf.toString());</span><br><span class="line">        return this.sbuf.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>所以15:00:00+0在调用toString方法后返回值是23:00:00.000000 +08:00:00,但是数据库中event_time类型时Time without timezone,所为23后面的时区信息将会被忽略,最终数据库的时间变成了UTC+0 的23:00:00点</p>
<p>而将event_time从数据库中查询出来时,又将其当成了UTC+8的23:00:00,换算成UTC+0时间正好是UTC+0 15:00:00</p>
<p>所以要避免页面时间与数据库时间不统一的办法就是设置JVM的时区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Duser.timezone&#x3D;UTC</span><br></pre></td></tr></table></figure>



        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/13/Hibernate%E5%AD%A6%E4%B9%A0/">Hibernate学习</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-13
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="占位符（named-parameters）对order-by无效"><a href="#占位符（named-parameters）对order-by无效" class="headerlink" title="占位符（named parameters）对order by无效"></a>占位符（named parameters）对order by无效</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;对于最后两字段sortField和sortOrder设值时是没有效果的</span><br><span class="line">SELECT * FROM t_table WHERE column&#x3D;:param1 ORDER BY :sortField :sortOrder</span><br></pre></td></tr></table></figure>

<h3 id="isDirty细节"><a href="#isDirty细节" class="headerlink" title="isDirty细节"></a>isDirty细节</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def product &#x3D; Product.get(xxx)</span><br><span class="line">product.name &#x3D; &#39;anotherName&#39;</span><br><span class="line">product.save()</span><br><span class="line">product.isDirty() &#x2F;&#x2F;true</span><br><span class="line"></span><br><span class="line">def product &#x3D; Product.get(xxx)</span><br><span class="line">product.name &#x3D; &#39;anotherName&#39;</span><br><span class="line">product.save(flush:true)</span><br><span class="line">product.isDirty() &#x2F;&#x2F;false</span><br></pre></td></tr></table></figure>
<p>hibernate 中entity get时会有个loadstate 来记录entity的初始状态,调用isDirty方法将比较当前 entity和loadstate来判断entity是否发生改变,然而当flush:true时,将刷新loadstate状态,从时调用isDirty将反回true.</p>
<h3 id="Session-Flush"><a href="#Session-Flush" class="headerlink" title="Session Flush"></a>Session Flush</h3><ul>
<li>HQL查询会导致session flush<br>所以在调用isDirty前进行HQL查询会导致isDirty始终返回false</li>
</ul>
<h3 id="flush与transaction的联系"><a href="#flush与transaction的联系" class="headerlink" title="flush与transaction的联系"></a>flush与transaction的联系</h3><p>flush后Hibernate会生成SQL语句并执行，但只有环绕的transaction提交后才会真正的同步到数据库</p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/06/13/Groovy%E5%AD%A6%E4%B9%A0/">Groovy学习</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-13
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="sort方法作用于Set和List时的区别"><a href="#sort方法作用于Set和List时的区别" class="headerlink" title="sort方法作用于Set和List时的区别"></a>sort方法作用于Set和List时的区别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def a &#x3D; new HashSet()</span><br><span class="line">a &lt;&lt; [3, 1, 2]</span><br><span class="line"></span><br><span class="line">def b &#x3D; new ArrayList()</span><br><span class="line">b &lt;&lt; [2, 1, 3]</span><br><span class="line"></span><br><span class="line">assert b.sort().is(b) &#x2F;&#x2F;true</span><br><span class="line">assert a.sort().is(a) &#x2F;&#x2F;false</span><br></pre></td></tr></table></figure>

<h3 id="sum-and-flatten-作用于Collection时的区别"><a href="#sum-and-flatten-作用于Collection时的区别" class="headerlink" title="sum and flatten 作用于Collection时的区别"></a>sum and flatten 作用于Collection时的区别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[].sum() returns null</span><br><span class="line">[].flatten() returns []</span><br><span class="line">&#x2F;&#x2F;原因在于调用sum时默认initvalue为null,当list为空时直接返回initvalue</span><br><span class="line">private static Object sum(Iterable self, Object initialValue, boolean first) &#123;</span><br><span class="line">    Object result &#x3D; initialValue;</span><br><span class="line">    Object[] param &#x3D; new Object[1];</span><br><span class="line">    for (Object next : self) &#123;</span><br><span class="line">        param[0] &#x3D; next;</span><br><span class="line">        if (first) &#123;</span><br><span class="line">            result &#x3D; param[0];</span><br><span class="line">            first &#x3D; false;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        MetaClass metaClass &#x3D; InvokerHelper.getMetaClass(result);</span><br><span class="line">        result &#x3D; metaClass.invokeMethod(result, &quot;plus&quot;, param);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EqualsAndHashCode注解"><a href="#EqualsAndHashCode注解" class="headerlink" title="@EqualsAndHashCode注解"></a>@EqualsAndHashCode注解</h3><h4 id="当exclude类所有field及property时，会导制所有实例都相等"><a href="#当exclude类所有field及property时，会导制所有实例都相等" class="headerlink" title="当exclude类所有field及property时，会导制所有实例都相等"></a>当exclude类所有field及property时，会导制所有实例都相等</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@EqualsAndHashCode(excludes &#x3D; [&#39;x&#39;, &#39;y&#39;])</span><br><span class="line">static class Point &#123;</span><br><span class="line">    int x</span><br><span class="line">    int y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    def point0 &#x3D; new Point(x: 1, y: 1)</span><br><span class="line">    def point1 &#x3D; new Point(x: 2, y: 2)</span><br><span class="line">    assert point0 &#x3D;&#x3D; point1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="对ORM类慎用该注解，可能会导制关联丢失，当mutable字段变化时，会导制hash值改变，导制无法定位到槽位，"><a href="#对ORM类慎用该注解，可能会导制关联丢失，当mutable字段变化时，会导制hash值改变，导制无法定位到槽位，" class="headerlink" title="对ORM类慎用该注解，可能会导制关联丢失，当mutable字段变化时，会导制hash值改变，导制无法定位到槽位，"></a>对ORM类慎用该注解，可能会导制关联丢失，当mutable字段变化时，会导制hash值改变，导制无法定位到槽位，</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@EqualsAndHashCode</span><br><span class="line">static class Point &#123;</span><br><span class="line">    int x</span><br><span class="line">    int y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    def point0 &#x3D; new Point(x: 1, y: 1)</span><br><span class="line">    def point1 &#x3D; new Point(x: 2, y: 2)</span><br><span class="line">    def set &#x3D; new HashSet()</span><br><span class="line">    set &lt;&lt; point0</span><br><span class="line">    set &lt;&lt; point1</span><br><span class="line"></span><br><span class="line">    assert set.contains(point0)</span><br><span class="line"></span><br><span class="line">    point0.x &#x3D; 6</span><br><span class="line">    assert set.contains(point0)  &#x2F;&#x2F;false !!!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

      
      
  <nav class="pagination">
    
      <a class="prev" href="/page/5/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    
    
      <a class="next" href="/page/7/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


    
  </section>

          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:wancaibida@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/wancaibida" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2021

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">大丈夫没问题</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.2"></script>

  </body>
</html>
