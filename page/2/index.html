<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/atom.xml" title="Charles' Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.2" />



<link rel="canonical" href="https://w2x.me/page/2/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.2" />



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-77440077-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-77440077-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> Charles' Blog </title>
  <meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Charles' Blog" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Charles' Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags/">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories/">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Charles' Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            
            
              Categories
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              About
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <section id="posts" class="posts">
    
      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2020/02/09/Openwrt%E4%B8%8B%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AEmedium-com%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/">Openwrt下无法访问medium.com的解决办法</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-02-09
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>家里路由器刷了Openwrt系统，在访问<code>medium.com</code> ,<code>nytimes.com</code>等网站时，会时不时出现连接重置错误，今天花时间研究了下，终于解决了这个困扰我很久的问题，在此记录下。</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><ul>
<li>Chrome访问这些网站是会提示<code>ERR_CONNECTION_RESET</code>错误，反复刷新多次后又能打开网站。</li>
<li>用<code>wget -v</code>命令显示返回了ipv6地址并且会提示无法创建SSL连接错误。</li>
</ul>
<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>问题就出在ipv6上，openwrt默认会打开ipv6地址分配，这会导致电脑被分配到了一个ipv6地址，而chrome，safari在本机有ipv6的情况下，会优先访问这些网站的ipv6的地址，而路由器上的iptables只会对ipv4包进行转发，故访问这些网站的ipv6地址是无法被代理的。</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><p>关闭路由器ipv6地址分配，这样在没有ipv6地址的情况下会访问这些网站的ipv4地址，这样就可以被代理到了。</p>
<h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2:"></a>方法2:</h3><p>添加ip6tables规则，对ipv6也进行转发（没有尝试过）</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://superuser.com/questions/1131112/ipv4-only-wifi-in-an-ipv6-enabled-openwrt-router" target="_blank" rel="noopener">https://superuser.com/questions/1131112/ipv4-only-wifi-in-an-ipv6-enabled-openwrt-router</a></li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/12/10/Bitbucket-pipeline%E4%BC%A0%E9%80%92%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E5%8F%98%E9%87%8F/">Bitbucket pipeline传递文件内容变量</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-12-10
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>Bitbucket pipeline可以通过<code>Repository variables</code>来传递变量，但是如果变量包含一些特殊字符比如换行符，bitbucket就不能很好的处理，对于这种情况我们可以将变量用base64编码一下，在pipeline中再解码就可以解决这问题了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat file.txt | base64</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; in pipeline file</span><br><span class="line">echo $&#123;YOUR_ENV&#125; | base64 -d &gt; file.txt</span><br></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/12/06/Java-BufferedImage-OutOfMemoryError/">Java BufferedImage OutOfMemoryError</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-12-06
        </span>
        
          <span class="post-category">
            
              <a href="/categories/java/">java</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>最近遇到了BufferedImage OutOfMemoryError的问题，在此记录一下。</p>
<p>事情的起因是项目中有个功能需要将多张图片合并为一张，流程如下：</p>
<ol>
<li>有三个图片文件，<code>File A,File B,File C</code></li>
<li>通过<code>ImageIO.read(inputStream)</code> 将ABC转换成<code>BufferedImage</code>类型</li>
<li>通过<code>java.awt.image.BufferedImage#getWidth()</code>获取这三张图片中的最大宽度<code>maxWidth</code>，</li>
<li>计算另外两张图片等比例拉伸至<code>maxWidth</code>后的高度，将这三张图片的高度相加得到<code>maxHeight</code></li>
<li>创建一张<code>maxWidth * maxHeight</code>的图片</li>
<li>通过画布将三张图片写入到这张图片里</li>
</ol>
<p>主要代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">                val images &#x3D; mutableListOf&lt;BufferedImage&gt;()</span><br><span class="line">                ...</span><br><span class="line">                images.add(ImageIO.read(inputStream))</span><br><span class="line">                ...</span><br><span class="line">                joinImages(*images.toTypedArray())</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    fun joinImages(vararg imgs: BufferedImage): BufferedImage &#123;</span><br><span class="line">        val offset &#x3D; 20</span><br><span class="line"></span><br><span class="line">        val aggregateWidth &#x3D; imgs.maxBy &#123; it.width &#125;!!.width</span><br><span class="line">        val aggregateHeight &#x3D; imgs.sumBy &#123;</span><br><span class="line">            (it.height * aggregateWidth) &#x2F; it.width</span><br><span class="line">        &#125; + (imgs.size - 1) * offset</span><br><span class="line"></span><br><span class="line">        val newImage &#x3D; BufferedImage(aggregateWidth, aggregateHeight, BufferedImage.TYPE_INT_ARGB)</span><br><span class="line">        val g2 &#x3D; newImage.createGraphics()</span><br><span class="line">        val oldColor &#x3D; g2.color</span><br><span class="line"></span><br><span class="line">        g2.paint &#x3D; Color.white</span><br><span class="line">        g2.fillRect(0, 0, aggregateWidth, aggregateHeight)</span><br><span class="line">        g2.color &#x3D; oldColor</span><br><span class="line"></span><br><span class="line">        var y &#x3D; 0</span><br><span class="line"></span><br><span class="line">        imgs.forEach &#123;</span><br><span class="line">            val height &#x3D; (aggregateWidth * it.height) &#x2F; it.width</span><br><span class="line">            val scaled &#x3D; it.getScaledInstance(aggregateWidth, height, Image.SCALE_DEFAULT)</span><br><span class="line"></span><br><span class="line">            g2.drawImage(toBufferedImage(scaled), null, 0, y)</span><br><span class="line">            y +&#x3D; height + offset</span><br><span class="line">        &#125;</span><br><span class="line">        g2.dispose()</span><br><span class="line"></span><br><span class="line">        return newImage</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运行过程中发现第<code>4</code>和<code>17</code>行代码时不时会抛出OutOfMemoryError错误，研究了下发现有两个问题：</p>
<ol>
<li>对于jpeg格式的图片，java将其载入到内存时是不会对其进行压缩的，一个像素会占用3个字节的内存，如果图片的尺寸比较大，会占用非常大的内存，比如这张<a href="https://dummyimage.com/2000x2000/000/fff.jpg" target="_blank" rel="noopener">图片</a>，实际文件大小为84kb，载入到内存里后的大小为11mb：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val file &#x3D; File(&quot;&#x2F;Downloads&#x2F;fff.jpeg&quot;)</span><br><span class="line">val image &#x3D; ImageIO.read(FileInputStream(file))</span><br><span class="line"></span><br><span class="line">println(image.width)  &#x2F;&#x2F;2000</span><br><span class="line">println(image.height) &#x2F;&#x2F;2000</span><br><span class="line">println(ObjectSizeCalculator.getObjectSize(image)) &#x2F;&#x2F;12000928  -&gt; 11mb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>合并图片前代码将这三张图片一次性全部加载到内存里，这也会占用比较大的内存。</li>
</ol>
<p>对于问题1，目前只能规避这问题，加载图片前会预先判断下该图片会占用多少内存，对于会超出内存使用的jpeg图片不予合并。同时在代码第14行，我们对合并后的最大宽度进行限制，避免合并后的图片尺寸过大，占用的内存超出限制。</p>
<p>对于问题2，这三张图片可以按序加载，不用一次性全部加载到内存里，在需要合并时才加载到内存里，同时可以改进获取图片尺寸的代码，不用将图片加载到内存后再获取尺寸。</p>
<p>最终代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">fun getImageSize(file: File): Dimension &#123;</span><br><span class="line">    ImageIO.createImageInputStream(file).use &#123; &#96;in&#96; -&gt;</span><br><span class="line">        val readers &#x3D; ImageIO.getImageReaders(&#96;in&#96;)</span><br><span class="line">        if (readers.hasNext()) &#123;</span><br><span class="line">            val reader &#x3D; readers.next()</span><br><span class="line">            try &#123;</span><br><span class="line">                reader.input &#x3D; &#96;in&#96;</span><br><span class="line">                return Dimension(reader.getWidth(0), reader.getHeight(0))</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                reader.dispose()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Dimension(0, 0)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fun joinImages(vararg files: File): File &#123;</span><br><span class="line">    ...</span><br><span class="line">    val offset &#x3D; 20</span><br><span class="line">    val dimensions &#x3D; files.map &#123; getImageSize(it) &#125;</span><br><span class="line">    val aggregateWidth &#x3D; min(dimensions.maxBy &#123; it.width &#125;!!.width, 800)</span><br><span class="line">    val aggregateHeight &#x3D; dimensions.sumBy &#123; (it.height * aggregateWidth) &#x2F; it.width &#125; + (files.size - 1) * offset</span><br><span class="line">    val newImage &#x3D; try &#123;</span><br><span class="line">        BufferedImage(aggregateWidth, aggregateHeight, BufferedImage.TYPE_INT_ARGB)</span><br><span class="line">    &#125; catch (e: OutOfMemoryError) &#123;</span><br><span class="line">        ...</span><br><span class="line">        throw e</span><br><span class="line">    &#125;</span><br><span class="line">    val g2 &#x3D; newImage.createGraphics()</span><br><span class="line">    val oldColor &#x3D; g2.color</span><br><span class="line"></span><br><span class="line">    g2.paint &#x3D; Color.white</span><br><span class="line">    g2.fillRect(0, 0, aggregateWidth, aggregateHeight)</span><br><span class="line">    g2.color &#x3D; oldColor</span><br><span class="line"></span><br><span class="line">    var y &#x3D; 0</span><br><span class="line"></span><br><span class="line">    files.forEach &#123;</span><br><span class="line">        var image &#x3D; try &#123;</span><br><span class="line">            ImageIO.read(it)</span><br><span class="line">        &#125; catch (e: OutOfMemoryError) &#123;</span><br><span class="line">            ...</span><br><span class="line">            throw e</span><br><span class="line">        &#125;</span><br><span class="line">        val height &#x3D; (aggregateWidth * image.height) &#x2F; image.width</span><br><span class="line">        val scaled &#x3D; image.getScaledInstance(aggregateWidth, height, Image.SCALE_DEFAULT)</span><br><span class="line"></span><br><span class="line">        g2.drawImage(toBufferedImage(scaled), null, 0, y)</span><br><span class="line"></span><br><span class="line">        image.flush()</span><br><span class="line">        image &#x3D; null</span><br><span class="line"></span><br><span class="line">        y +&#x3D; height + offset</span><br><span class="line">    &#125;</span><br><span class="line">    g2.dispose()</span><br><span class="line"></span><br><span class="line">    val joinImageFile &#x3D; File.createTempFile(UUID.randomUUID().toString(), &quot;.png&quot;)</span><br><span class="line"></span><br><span class="line">    ImageIO.write(newImage, &quot;png&quot;, joinImageFile)</span><br><span class="line"></span><br><span class="line">    return joinImageFile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按上述代码修改后，再也没有发生OutOfMemoryError。对于问题1，目前发现<a href="https://commons.apache.org/proper/commons-imaging/whyimaging.html" target="_blank" rel="noopener">apache commons-imaging</a>似乎可以解决这问题，有时间去尝试下，到时候再来更新本文。</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://coderanch.com/t/416485/java/Java-BufferedImage-OutOfMemoryError" target="_blank" rel="noopener">https://coderanch.com/t/416485/java/Java-BufferedImage-OutOfMemoryError</a></p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/11/28/Kubernetes%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEJVM%E5%86%85%E5%AD%98/">Kubernetes环境配置JVM内存</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-11-28
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>我们知道JVM在docker容器环境中是无法正确检测到可用内存的，最近正好遇到了一个与之相关的问题，在此记录一下。</p>
<p>遇到问题的项目技术栈为JDK 8 + Spring Boot + Tomcat，部署在docker环境。项目运行过程中出现了<code>java.lang.OutOfMemoryError: Java heap space</code>异常，当时项目的部署文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: api-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: api</span><br><span class="line">spec:</span><br><span class="line">  serviceName: api-app</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      containers:</span><br><span class="line">        - image: ...</span><br><span class="line">          imagePullPolicy: &quot;Always&quot;</span><br><span class="line">          name: api</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 300</span><br><span class="line">            periodSeconds: 5</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 60</span><br><span class="line">            periodSeconds: 5</span><br><span class="line">          securityContext:</span><br><span class="line">            capabilities:</span><br><span class="line">              add:</span><br><span class="line">                - SYS_PTRACE </span><br><span class="line">          envFrom:</span><br><span class="line">            - secretRef:</span><br><span class="line">                name: secret</span><br></pre></td></tr></table></figure>
<p>问题应该出在k8s内存设置与JVM的配置这边，网上查询资料后发现tomcat可以通过<code>CATALINA_OPTS</code>环境变量来设置JVM参数，<code>UseCGroupMemoryLimitForHeap</code> 可以让JVM自动检测容器的可用内存，<code>MaxRAMFraction</code> 为容器内存和堆内存的比例，比如容器内存为2G，MaxRAMFraction为2，则最大堆内存为2G/2=1G，这里将<code>MaxRAMFraction</code>设置为2比较安全，设置了这两个参数后，JVM就能通过检测容器的内存来自动调整堆内存大小，不用再显示设置堆内存了。</p>
<p>更新后的配置文件里加了如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">          env:</span><br><span class="line">              - name: CATALINA_OPTS</span><br><span class="line">                value: &quot;-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction&#x3D;2&quot;</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              memory: &quot;512Mi&quot;</span><br></pre></td></tr></table></figure>

<p>项目运行一段时间后发现问题依旧，研究了下<code>UseCGroupMemoryLimitForHeap</code>参数，发现它是通过读取系统<code>/sys/fs/cgroup/memory/memory.limit_in_bytes</code>文件来检测内存的，登录到容器里查看了下该文件，发现里面是一个很大的值：<code>9223372036854771712</code>，等于没有内存限制，查了下资料发现这个字段是通过k8s文件中的<code>resources-&gt;limits</code>的这个属性来配置的，更新文件，加了如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limits:</span><br><span class="line">  memory: &quot;2048Mi&quot;</span><br></pre></td></tr></table></figure>

<p>观察一段时间后内存就没再溢出，最终完整配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: api-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: api</span><br><span class="line">spec:</span><br><span class="line">  serviceName: api-app</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      containers:</span><br><span class="line">        - image: ...</span><br><span class="line">          imagePullPolicy: &quot;Always&quot;</span><br><span class="line">          name: api</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 300</span><br><span class="line">            periodSeconds: 5</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 60</span><br><span class="line">            periodSeconds: 5</span><br><span class="line">          securityContext:</span><br><span class="line">            capabilities:</span><br><span class="line">              add:</span><br><span class="line">                - SYS_PTRACE </span><br><span class="line">          env:</span><br><span class="line">              - name: CATALINA_OPTS</span><br><span class="line">                value: &quot;-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction&#x3D;2&quot;</span><br><span class="line">          envFrom:</span><br><span class="line">            - secretRef:</span><br><span class="line">                name: secret</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              memory: &quot;512Mi&quot;</span><br><span class="line">            limits:</span><br><span class="line">              memory: &quot;2048Mi&quot;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/docker-library/tomcat/issues/157" target="_blank" rel="noopener">https://github.com/docker-library/tomcat/issues/157</a></li>
<li><a href="https://blog.csanchez.org/2017/05/31/running-a-jvm-in-a-container-without-getting-killed/" target="_blank" rel="noopener">https://blog.csanchez.org/2017/05/31/running-a-jvm-in-a-container-without-getting-killed/</a></li>
<li><a href="https://www.logicbig.com/how-to/java-command/jvm-option-list.html" target="_blank" rel="noopener">https://www.logicbig.com/how-to/java-command/jvm-option-list.html</a></li>
<li><a href="https://medium.com/adorsys/jvm-memory-settings-in-a-container-environment-64b0840e1d9e" target="_blank" rel="noopener">https://medium.com/adorsys/jvm-memory-settings-in-a-container-environment-64b0840e1d9e</a></li>
<li><a href="https://stackoverflow.com/a/53826135/1776024" target="_blank" rel="noopener">https://stackoverflow.com/a/53826135/1776024</a></li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/11/11/Google-Cloud-Pub-Sub%E7%9A%84%E4%B8%80%E4%BA%9B%E7%A0%94%E7%A9%B6/">Google Cloud Pub Sub的一些研究</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-11-11
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <ul>
<li>多个客户端可以使用一个<code>subscription</code>，每个客户端只会收到一部分的消息：</li>
</ul>
<blockquote>
<p>Multiple subscribers can make pull calls to the same “shared” subscription. Each subscriber will receive a subset of the messages<br>出处：<a href="https://cloud.google.com/pubsub/docs/subscriber#push-subscription" target="_blank" rel="noopener">https://cloud.google.com/pubsub/docs/subscriber#push-subscription</a></p>
</blockquote>
<ul>
<li>对于一些处理比较耗时的消息，客户端有后台任务会自动更新ack<br>deadline，详情可见<a href="https://github.com/googleapis/google-cloud-java/blob/v0.99.0/google-cloud-clients/google-cloud-pubsub/src/main/java/com/google/cloud/pubsub/v1/MessageDispatcher.java#L400" target="_blank" rel="noopener">extendDeadlines</a>方法。</li>
</ul>
<ul>
<li>关于<code>Message retention duration</code></li>
</ul>
<blockquote>
<p>By default, a message that cannot be delivered within the maximum retention time of 7 days is deleted and is no longer accessible. This typically happens when subscribers do not keep up with the flow of messages. Note that you can configure message retention duration (the range is from 10 minutes to 7 days).</p>
</blockquote>
<p>意思就是如果消息在<code>Message retention duration</code>时间内没有被处理完成的话，这条消息就会删除并且再也访问不到。</p>
<p>比如程序的BUG导致消息一直无法被处理，经过 <code>Message retention duration</code> 后这条消息就再也收不到了，会导致数据丢失。</p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/10/23/Safari-can-t-establish-a-secure-connection-%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/">Safari can't establish a secure connection 解决办法</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-10-23
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>公司测试用的是6.x版本的Safari，在测试时发现无法打开项目网站，提示<code>Safari can&#39;t establish a secure connection</code>错误，测试了下其他网站也只有一部分能打开。</p>
<p>一开始以为是系统配置的问题，尝试了下网上的解决方案如：修改DNS服务器地址，信任证书等，发现还是无法打开项目网站。后来发现Safari 6.x是不支持TLS 1.2版本的，而我们项目用的正好是1.2版本的TLS。</p>
<p>解决办法：</p>
<ol>
<li>升级Safari版本</li>
<li>让项目支持低版本的TLS</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://www.projectdatasphere.org/projectdatasphere/html/tls/faq" target="_blank" rel="noopener">https://www.projectdatasphere.org/projectdatasphere/html/tls/faq</a></li>
<li><a href="https://www.howsmyssl.com/" target="_blank" rel="noopener">https://www.howsmyssl.com/</a></li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/09/19/Google-Cloud-Function-Http-%E8%AE%A4%E8%AF%81%E9%85%8D%E7%BD%AE/">Google Cloud Function Http 认证配置</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-19
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>最近在做的项目用到了google cloud，其中有个功能模块的google cloud function需要调用另一个通过http请求触发的function，在研究配置http function认证信息期间花了不少时间，在这记录一下。</p>
<p>默认情况下创建http请求触发的function会勾选<code>Allow unauthenticated invocations</code>选项，这样无需通过认证就可以调用function，但这样做显然是不安全的，一旦接口地址泄漏就可能会被恶意调用。</p>
<p>查看了google cloud文档，google建议用<a href="https://cloud.google.com/endpoints/" target="_blank" rel="noopener">Cloud Endpoint</a>来做认证，但是在cloud console始终无法创建endpoint，遂放弃。</p>
<p>一开始想了个临时的解决方案：在勾选<code>Allow unauthenticated invocations</code>的情况下，在function代码里加上token验证，如果token不匹配就返回并提示<code>forbidden</code>，虽然可以减少function在被恶意调用的情况下的执行时间，但还是会产生一定的费用。</p>
<p>今天抽时间重新研究了下这个问题，终于找到了<a href="https://cloud.google.com/functions/docs/securing/authenticating#function-to-function" target="_blank" rel="noopener">解决方案</a>：</p>
<p>假设调用者function为 <code>xxx-master</code>，被调用的function为<code>xxx-slave</code>,</p>
<ul>
<li>通过下面命令给 <code>xxx-slave</code> function加上<code>roles/cloudfunctions.invoker</code> 角色，允许 <code>roles/cloudfunctions.invoker</code>这个角色来调用<code>xxx-slave</code> function</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcloud beta functions add-iam-policy-binding RECEIVING_FUNCTION \</span><br><span class="line">  --member&#x3D;&#39;serviceAccount:CALLING_FUNCTION_IDENTITY&#39; \</span><br><span class="line">  --role&#x3D;&#39;roles&#x2F;cloudfunctions.invoker&#39;</span><br></pre></td></tr></table></figure>

<p><code>RECEIVING_FUNCTION</code> -&gt; 被调用的function名字<br><code>CALLING_FUNCTION_IDENTITY</code> -&gt; 一般为 <code>PROJECT_ID@appspot.gserviceaccount.com</code></p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcloud beta functions add-iam-policy-binding xxx-slave \</span><br><span class="line">  --member&#x3D;&#39;serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com&#39; \</span><br><span class="line">  --role&#x3D;&#39;roles&#x2F;cloudfunctions.invoker&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 <code>xxx-master</code> function中加上获取token代码，请求时将token放在<code>Authorization</code> header里，以python为例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Requests is already installed, no need to add it to requirements.txt</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def calling_function(request):</span><br><span class="line">  # Make sure to replace variables with appropriate values</span><br><span class="line">  receiving_function_url &#x3D; &#39;https:&#x2F;&#x2F;us-central1-graphical-bus-248617.cloudfunctions.net&#x2F;xxx-slave</span><br><span class="line">&#39;</span><br><span class="line"></span><br><span class="line">  # Set up metadata server request</span><br><span class="line">  # See https:&#x2F;&#x2F;cloud.google.com&#x2F;compute&#x2F;docs&#x2F;instances&#x2F;verifying-instance-identity#request_signature</span><br><span class="line">  metadata_server_token_url &#x3D; &#39;http:&#x2F;&#x2F;metadata&#x2F;computeMetadata&#x2F;v1&#x2F;instance&#x2F;service-accounts&#x2F;default&#x2F;identity?audience&#x3D;&#39;</span><br><span class="line"></span><br><span class="line">  token_request_url &#x3D; metadata_server_token_url + receiving_function_url</span><br><span class="line">  token_request_headers &#x3D; &#123;&#39;Metadata-Flavor&#39;: &#39;Google&#39;&#125;</span><br><span class="line"></span><br><span class="line">  # Fetch the token</span><br><span class="line">  token_response &#x3D; requests.get(token_request_url, headers&#x3D;token_request_headers)</span><br><span class="line">  jwt &#x3D; token_response.content.decode(&quot;utf-8&quot;)</span><br><span class="line"></span><br><span class="line">  # Provide the token in the request to the receiving function</span><br><span class="line">  receiving_function_headers &#x3D; &#123;&#39;Authorization&#39;: f&#39;bearer &#123;jwt&#125;&#39;&#125;</span><br><span class="line">  function_response &#x3D; requests.get(receiving_function_url, headers&#x3D;receiving_function_headers)</span><br><span class="line"></span><br><span class="line">  return function_response.content</span><br></pre></td></tr></table></figure>

<p>完成上面两部后，<code>xxx-slave</code> function就可以在被认证的情况下调用了。</p>
<p>这里还需要注意的是要将<code>Cloud Functions Invoker</code> 中的 <code>all user</code>移除，不然<code>xxx-slave</code>方法还是公开的，操作步骤：</p>
<ul>
<li>Google Cloud Console -&gt; Cloud Function</li>
<li>勾选<code>xxx-slave</code> function</li>
<li>点击左侧的 <code>PERMISSIONS</code> tab</li>
<li>点开 <code>Cloud Functions Invoker</code></li>
<li>将 <code>all user</code>移除</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://cloud.google.com/functions/docs/securing/authenticating#function-to-function" target="_blank" rel="noopener">https://cloud.google.com/functions/docs/securing/authenticating#function-to-function</a></li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/08/24/Google-Cloud%E9%83%A8%E7%BD%B2web-app%E5%88%B0kubernetes%E5%B9%B6%E4%BD%BF%E7%94%A8let%E2%80%99s-encrypt%E5%92%8Cnginx-ingress/">Google Cloud使用kubernetes，let’s encrypt和nginx-ingress部署web app</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-24
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="连接cluster"><a href="#连接cluster" class="headerlink" title="连接cluster"></a>连接cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud container clusters get-credentials CLUSER_NAME --zone us-central1-a --project PROJECT_NAME</span><br></pre></td></tr></table></figure>

<h3 id="安装helm和tiller"><a href="#安装helm和tiller" class="headerlink" title="安装helm和tiller"></a>安装helm和tiller</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole&#x3D;cluster-admin --serviceaccount&#x3D;kube-system:tiller</span><br><span class="line">helm init --service-account tiller</span><br></pre></td></tr></table></figure>

<h3 id="安装nginx-ingress"><a href="#安装nginx-ingress" class="headerlink" title="安装nginx-ingress"></a>安装nginx-ingress</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install --name nginx-ingress stable&#x2F;nginx-ingress --set rbac.create&#x3D;true --set controller.publishService.enabled&#x3D;true</span><br></pre></td></tr></table></figure>

<h3 id="安装let’s-encrypt"><a href="#安装let’s-encrypt" class="headerlink" title="安装let’s encrypt"></a>安装let’s encrypt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;jetstack&#x2F;cert-manager&#x2F;release-0.8&#x2F;deploy&#x2F;manifests&#x2F;00-crds.yaml</span><br><span class="line"></span><br><span class="line">helm repo add jetstack https:&#x2F;&#x2F;charts.jetstack.io</span><br><span class="line">helm install --name cert-manager --namespace cert-manager jetstack&#x2F;cert-manager</span><br><span class="line"></span><br><span class="line">kubectl create -f issuer.yaml</span><br></pre></td></tr></table></figure>

<p><a href="https://raw.githubusercontent.com/wancaibida/kubernetes-sample-app/master/issuer.yaml" target="_blank" rel="noopener">issuer.yaml</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: certmanager.k8s.io&#x2F;v1alpha1</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: letsencrypt-prod</span><br><span class="line">spec:</span><br><span class="line">  acme:</span><br><span class="line">    # The ACME server URL</span><br><span class="line">    server: https:&#x2F;&#x2F;acme-v02.api.letsencrypt.org&#x2F;directory</span><br><span class="line">    # Email address used for ACME registration</span><br><span class="line">    email: youremail@yourdomain.com</span><br><span class="line">    # Name of a secret used to store the ACME account private key</span><br><span class="line">    privateKeySecretRef:</span><br><span class="line">      name: letsencrypt-prod</span><br><span class="line">    # Enable the HTTP-01 challenge provider</span><br><span class="line">    http01: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置DNS"><a href="#配置DNS" class="headerlink" title="配置DNS"></a>配置DNS</h3><p>获取nginx-ingress-controller的IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n default</span><br></pre></td></tr></table></figure>
<p>output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)                      AGE</span><br><span class="line">kubernetes                      ClusterIP      10.64.0.1      &lt;none&gt;          443&#x2F;TCP                      64m</span><br><span class="line">nginx-ingress-controller        LoadBalancer   10.64.11.170   35.188.93.188   80:30393&#x2F;TCP,443:30515&#x2F;TCP   59m</span><br><span class="line">nginx-ingress-default-backend   ClusterIP      10.64.5.162    &lt;none&gt;          80&#x2F;TCP                       59m</span><br></pre></td></tr></table></figure>
<p>将你的DNS记录指向 EXTERNAL-IP -&gt; <code>35.188.93.188</code></p>
<h2 id="部署web项目"><a href="#部署web项目" class="headerlink" title="部署web项目"></a>部署web项目</h2><h3 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns demo</span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace&#x3D;demo</span><br></pre></td></tr></table></figure>

<h3 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h3><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure>

<p><a href="https://raw.githubusercontent.com/wancaibida/kubernetes-sample-app/master/deployment.yaml" target="_blank" rel="noopener">deplyment.yaml</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: api-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: api</span><br><span class="line">spec:</span><br><span class="line">  serviceName: api-app</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      containers:</span><br><span class="line">        - image: tomcat:8.5.45-jdk8-openjdk-slim</span><br><span class="line">          imagePullPolicy: &quot;Always&quot;</span><br><span class="line">          name: api</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 150</span><br><span class="line">            periodSeconds: 5</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 150</span><br><span class="line">            periodSeconds: 5</span><br></pre></td></tr></table></figure>

<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure>

<p><a href="https://raw.githubusercontent.com/wancaibida/kubernetes-sample-app/master/service.yaml" target="_blank" rel="noopener">service.yaml</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: api-service</span><br><span class="line">  labels:</span><br><span class="line">    app: api</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    app: api</span><br><span class="line">  ports:</span><br><span class="line">   - protocol: TCP</span><br><span class="line">     port: 80</span><br><span class="line">     targetPort: 8080</span><br></pre></td></tr></table></figure>

<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress.yaml</span><br></pre></td></tr></table></figure>

<p><a href="https://raw.githubusercontent.com/wancaibida/kubernetes-sample-app/master/ingress.yaml" target="_blank" rel="noopener">ingress.yaml</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: name-virtual-host-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: nginx</span><br><span class="line">    certmanager.k8s.io&#x2F;cluster-issuer: letsencrypt-prod</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;ssl-redirect: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls: # &lt; placing a host in the TLS config will indicate a cert should be created</span><br><span class="line">  - hosts:</span><br><span class="line">    - demo.w2x.me</span><br><span class="line">    secretName: letsencrypt-prod</span><br><span class="line">  rules:</span><br><span class="line"></span><br><span class="line">  - host: demo.w2x.me</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: api-service</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<p>等<code>deployment</code>的<code>pod ready</code>后，访问你配置的域名，就可以看到https加密后的tomcat主页了。</p>
<h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><ul>
<li><a href="https://cloud.google.com/community/tutorials/nginx-ingress-gke" target="_blank" rel="noopener">https://cloud.google.com/community/tutorials/nginx-ingress-gke</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-on-digitalocean-kubernetes-using-helm" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-on-digitalocean-kubernetes-using-helm</a></li>
<li><a href="https://gist.github.com/snormore/c7c2935d746531ed0d75064a6ad6058e" target="_blank" rel="noopener">https://gist.github.com/snormore/c7c2935d746531ed0d75064a6ad6058e</a></li>
<li><a href="https://github.com/helm/helm/issues/3130#issuecomment-372931407" target="_blank" rel="noopener">https://github.com/helm/helm/issues/3130#issuecomment-372931407</a></li>
<li><a href="https://github.com/wancaibida/kubernetes-sample-app" target="_blank" rel="noopener">kubernetes-sample-app</a></li>
</ul>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><ul>
<li>2019-09-08: 添加了let’s encrypt部分缺失的安装步骤。</li>
</ul>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/07/25/zsh%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8E%86%E5%8F%B2%E5%90%8C%E6%AD%A5%E6%8F%92%E4%BB%B6%E6%8E%A8%E8%8D%90/">Zsh命令行历史同步插件推荐</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-07-25
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>公司和家里用的是两台电脑，经常遇到一些用过却记不住的命令，恰巧这些命令在另外台电脑执行过，就想找个能在不同机器上同步命令行历史的插件。</p>
<p>尝试过将用户目录文件夹下的<code>.zsh_history</code>文件软链接到dropbox，发现还是有点问题，比如多台机器同步是会发生文件冲突，一些情况下zsh会重新创建新的<code>.zsh_history</code>文件，导致数据丢失。期间又尝试了下<a href="https://github.com/wulfgarpro/history-sync" target="_blank" rel="noopener">history-sync</a>这个插件，发现有会将历史文件清空的BUG。</p>
<p>无意中发现了<a href="https://github.com/larkery/zsh-histdb" target="_blank" rel="noopener">zsh-histdb</a>，这个插件正好满足了我的要求：在多台电脑之间同步历史记录，自动合并冲突文件。配合<a href="https://github.com/zsh-users/zsh-autosuggestions" target="_blank" rel="noopener">zsh-autosuggestions</a>简直完美。</p>

        
      
    </div>

    

    

  </article>

      
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/06/30/Docker%E7%8E%AF%E5%A2%83%E8%AE%BF%E9%97%AEfontello-com%E6%97%A0%E9%99%90%E9%87%8D%E5%AE%9A%E5%90%91%E9%97%AE%E9%A2%98/">Docker环境访问fontello.com无限重定向问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-06-30
        </span>
        
          <span class="post-category">
            
              <a href="/categories/linux/">linux</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>前阵子要把公司几个年代比较久远的前端项目迁移到新的jenkins环境，由于这些项目打包依赖库的版本比较老，要配置好环境会比较花时间，以后再迁移环境的话还要在搭建一遍，于是就想着用docker来打包项目。</p>
<p>本地搭建好docker环境后，测试打包的时候发现项目从fontello.com下载字体是老是会报一个超出最大重定向次数的异常，ssh到docker环境发现 <code>wget -vdS fontello.com</code> 返回的Response状态码一直是302，而本机环境和服务器都没这问题，docker环境<code>wget</code>其他网址也没有问题，一开始以为是fontello网站配置的问题，今天突然冒出一个想法会不会是我docker环境配置了代理的原因，于是将 <code>fontello.com</code> 域名加到了代理白名单里，发现就没有重定向异常了，字体文件能正常下载了。</p>
<p>这个问题的根本原因很有可能是docker代理功能和 <code>fontello.com</code> 两边的问题，在这里记一下，以防下次再遇到类似问题。</p>

        
      
    </div>

    

    

  </article>

      
      
  <nav class="pagination">
    
      <a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    
    
      <a class="next" href="/page/3/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


    
  </section>

          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:wancaibida@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/wancaibida" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">大丈夫没问题</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.2"></script>

  </body>
</html>
