<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>HPKP(HTTP Public Key Pinning)详解 | W2X</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-77440077-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HPKP(HTTP Public Key Pinning)详解</h1><a id="logo" href="/.">W2X</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">HPKP(HTTP Public Key Pinning)详解</h1><div class="post-meta">Jul 3, 2017<span> | </span><span class="category"><a href="/categories/Security/">Security</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/" href="/2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="HPKP是什么"><a href="#HPKP是什么" class="headerlink" title="HPKP是什么"></a>HPKP是什么</h3><p>HPKP(HTTP Public Key Pinning)又名公钥打孔,可以通过告知客户端将特定的加密公钥与特定服务器关联,以减少通过伪造证书进行中间人攻击(MITM)的风险.</p>
<h3 id="HPKP原理"><a href="#HPKP原理" class="headerlink" title="HPKP原理"></a>HPKP原理</h3><p>HPKP是一种首次信任技术,当客户端第一次访问服务器的时候,服务器通过特定的HTTP头来告知客户端哪些公钥是属于它的,客户端会将该信息存储一段时间,当客户端第二次访问服务端的时候,它会期望当前证书链中至少有一个证书的公钥指纹与通过HPKP已知的公钥指纹相匹配,如果没有找到匹配的公钥指纹,客户端应该警告用户.</p>
<h3 id="生成HPKP"><a href="#生成HPKP" class="headerlink" title="生成HPKP"></a>生成HPKP</h3><p>公钥指纹可以通过openssl命令来成成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line"> </div><div class="line">openssl s_client -connect [YOUR_DOMAIN]:443 -showcerts | awk &apos;/-----BEGIN/&#123;f=&quot;cert.&quot;(n++)&#125; f&#123;print&gt;f&#125; /-----END/&#123;f=&quot;&quot;&#125;&apos;</div><div class="line"> </div><div class="line"> for c in cert.*; do</div><div class="line">   openssl x509 &lt;$c -noout -pubkey | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</div><div class="line"> done</div></pre></td></tr></table></figure>
<p>上面的命令会将当前证书链中的所有公钥指纹以base64格式打印出来.</p>
<p>公钥指纹也可以通过在线网站<a href="https://report-uri.io/home/pkp_hash" target="_blank" rel="external">REPORT URI</a>来生成 </p>
<h3 id="备份密钥-Backup-Key"><a href="#备份密钥-Backup-Key" class="headerlink" title="备份密钥(Backup Key)"></a>备份密钥(Backup Key)</h3><h4 id="什么是备份密钥"><a href="#什么是备份密钥" class="headerlink" title="什么是备份密钥"></a>什么是备份密钥</h4><p>备份密钥是不属于当前证书链的公钥指纹</p>
<h4 id="为什么要备份密钥"><a href="#为什么要备份密钥" class="headerlink" title="为什么要备份密钥"></a>为什么要备份密钥</h4><p>假设你只对你的子证书(leaf certificate)做了公钥指纹,你发现你的证书私钥被泄露了,这时你不得不更换当前的证书,这时唯一能恢复的办法就是将当前证书切换到备份密钥指向的备份证书.</p>
<h3 id="其他类似备份密钥的方法"><a href="#其他类似备份密钥的方法" class="headerlink" title="其他类似备份密钥的方法"></a>其他类似备份密钥的方法</h3><p>备份密钥的缺点也很明显,你需要同时支付至少两份证书的钱.</p>
<p>另一个办法就是你可以拿另一家证书颁发机构(CA)的公钥指纹做为备份密钥,当你要更换证书的时候,你只需要在这家CA申请一份新的证书.当然这么做也有缺点,当这家CA被黑,攻击者可以给自己颁发一份你网站的证书同时又通过你的HPKP验证,应为这份恶意证书也在CA的证书链上.</p>
<p>MDN上建议网站要有一个备份密钥</p>
<blockquote>
<p>HPKP has the potential to lock out users for a long time if used incorrectly! The use of backup certificates and/or pinning the CA certificate is recommended.</p>
</blockquote>
<p>但在Chrome(59.0.3071.115)下测试,如果HPKP头不包含备份密钥Chrome将忽略该头.</p>
<h3 id="添加HPKP头"><a href="#添加HPKP头" class="headerlink" title="添加HPKP头"></a>添加HPKP头</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.setHeader(&apos;Public-Key-Pins&apos;, &apos;pin-sha256=&quot;base64+primary==&quot;; pin-sha256=&quot;base64+backup==&quot;; max-age=5184000; includeSubDomains&apos;)</div></pre></td></tr></table></figure>
<p><strong>sha256</strong><br>公钥的哈希值,base64编码</p>
<p><strong>max-age</strong><br>在浏览器的存储时间</p>
<p><strong>includeSubDomains</strong><br>对子域名是否有效</p>
<p><strong>report-uri</strong><br>验证失败后调用的URL(注:必须不同域名)</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>用HPKP的网站比较少,就发现github在用.</p>
<p>HPKP缺点也很明显:出错的成本太高,当你不得不切换到备份密钥指向的证书时,如果备份密钥配错了而且你只有一个备份密钥,你的网站将会无法被访问,无法访问的时间取决于max-age的值,比如上面的例子max-age配了两个月,那你的用户将在两个月内无法访问你的网站,这后果是灾难性的.</p>
<p>个人认为HPKP带来的风险大于收益,不建议使用.</p>
<h3 id="外部链接"><a href="#外部链接" class="headerlink" title="外部链接"></a>外部链接</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning" target="_blank" rel="external">HTTP Public Key Pinning (HPKP)</a></p>
<p><a href="https://timtaubert.de/blog/2014/10/http-public-key-pinning-explained/" target="_blank" rel="external">HTTP PUBLIC-KEY-PINNING EXPLAINED
</a></p>
<p><a href="https://scotthelme.co.uk/guidance-on-setting-up-hpkp/" target="_blank" rel="external">Guidance on setting up HPKP
</a></p>
<p><a href="https://blog.qualys.com/ssllabs/2016/09/06/is-http-public-key-pinning-dead" target="_blank" rel="external">Is HTTP Public Key Pinning Dead?</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://w2x.me/2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/" data-id="cjbaugouf0003kw198dh4g48u" class="article-share-link">Share</a><div class="tags"><a href="/tags/HPKP/">HPKP</a></div><div class="post-nav"><a href="/2017/08/06/Linux下启动Java守护进程方法/" class="pre">Linux下启动Java守护进程方法</a><a href="/2017/06/14/PostgreSQL-JDBC-time类型转换细节/" class="next">PostgreSQL JDBC time类型存取细节</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'w2x-me';
var disqus_identifier = '2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/';
var disqus_title = 'HPKP(HTTP Public Key Pinning)详解';
var disqus_url = 'http://w2x.me/2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//w2x-me.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://w2x.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/App/">App</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/">IDE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Kubernetes/" style="font-size: 15px;">Kubernetes</a> <a href="/tags/Groovy/" style="font-size: 15px;">Groovy</a> <a href="/tags/HPKP/" style="font-size: 15px;">HPKP</a> <a href="/tags/Intellij/" style="font-size: 15px;">Intellij</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Hibernate/" style="font-size: 15px;">Hibernate</a> <a href="/tags/PostgreSQL/" style="font-size: 15px;">PostgreSQL</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/yaml/" style="font-size: 15px;">yaml</a> <a href="/tags/Grails/" style="font-size: 15px;">Grails</a> <a href="/tags/JSON/" style="font-size: 15px;">JSON</a> <a href="/tags/Youtube/" style="font-size: 15px;">Youtube</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/介绍一款可以用后台播放来『听』视频的软件/">介绍一款可以用后台播放来『听』视频的软件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/记一个Grails-JSON-Views的Bug/">记一个Grails JSON Views的Bug</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/Intellij远程调试Tomcat/">Intellij远程调试Tomcat</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/Kubernetes入门/">Kubernetes入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Spring-Boot-配置文件设置默认值/">Spring Boot YAML配置文件设置字段默认值</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/Linux下启动Java守护进程方法/">Linux下启动Java守护进程方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/HPKP-HTTP-Public-Key-Pinning-详解/">HPKP(HTTP Public Key Pinning)详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/PostgreSQL-JDBC-time类型转换细节/">PostgreSQL JDBC time类型存取细节</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/Hibernate学习/">Hibernate学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/Groovy学习/">Groovy学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//w2x-me.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/wancaibida" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">W2X.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>